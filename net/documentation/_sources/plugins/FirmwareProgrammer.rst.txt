.. _cliFirmwareProgrammerPage:

Firmware Programmer
###################

The Firmware Programmer plugin contains everything necessary to update the firmware on a VectorNav unit. For most use cases, a single call to the :func:`FirmwareProgrammer::FirmwareUpdater::UpdateFirmware() <VNSDK::FirmwareProgrammer::FirmwareUpdater::UpdateFirmware>` method is all that is required. This method is overloaded to accept either a list of VNX files or a file path to a single VNXML file and is the preferred approach for updating the firmware on a VectorNav unit.

.. note::
    This plugin will work with any sensor which accepts the Set Boot Loader command. Additional information on the firmware update process can be found in the Firmware Update Protocol technical note. Please reach out to support@vectornav.com to obtain the VNX or VNXML file(s) for your specific sensor.


Usage
=====

.. warning::
    As a part of the firmware update, this plugin will issue a Restore Factory Settings. To ensure preservation of configuration settings, it is recommended to perform a register scan before updating the firmware version. Information on how to perform a register scan can be found on the :ref:`cliRegisterScanPage` page.

As demonstrated in the Firmware Update example, to use the Firmware Programmer plugin it is first necessary to create a :class:`~VNSDK::Sensor` object and connect to the VectorNav unit using the :func:`~VNSDK::Sensor::Connect` method. A :class:`FirmwareProgrammer::FirmwareUpdater <VNSDK::FirmwareProgrammer::FirmwareUpdater>` object should also be created.


.. tab:: C#

   .. literalinclude:: ../../../cs/examples/FirmwareUpdate/FirmwareUpdate.cs
      :language: C#
      :start-at: // 1.
      :end-at: FirmwareProgrammer.FirmwareUpdater
      :dedent: 12

.. tab:: MATLAB

   .. literalinclude:: ../../../matlab/examples/FirmwareUpdate/FirmwareUpdate.m
      :language: matlab
      :start-at: % 1.
      :end-at: firmwareUpdater 

.. note::
    Because it cannot be assumed that the sensor has a valid firmware, connecting using the :func:`~VNSDK::Sensor::AutoConnect` method or verifying connectivity using the  :func:`~VNSDK::Sensor::VerifySensorConnectivity` method are not recommended.

Next, the file path(s) for the firmware file(s) need to be specified and passed to the :func:`FirmwareProgrammer::FirmwareUpdater::UpdateFirmware() <VNSDK::FirmwareProgrammer::FirmwareUpdater::UpdateFirmware>` method. Either a relative file path or an absolute file path can be used. Additionally, in the :func:`FirmwareProgrammer::FirmwareUpdater::UpdateFirmware() <VNSDK::FirmwareProgrammer::FirmwareUpdater::UpdateFirmware>` call, the firmware baud rate and bootloader baud rate can be specifiedk as input parameters. The default value for each is 115200 bps. 

.. note::
    To speed up the firmware update, the bootloader can be set to update at higher rates (maximum of 460800 bps) using the ``bootloaderBaudRate`` parameter.

To update a VectorNav unit using a VNXML file, a ``String`` object should be used:

.. tab:: C#

    .. code-block:: C#
    
        string vnxmlPath = "VN310.vnxml";
        FirmwareProgrammer.FirmwareUpdater.Params fwUpdateParams = new FirmwareProgrammer.FirmwareUpdater.Params(firmwareBaudRate, bootloaderBaudRate);
        firmwareUpdater.UpdateFirmware(ref sensor, vnxmlPath, fwUpdateParams);

.. tab:: MATLAB

    .. code-block:: matlab

        vnxml_path = 'VN310.vnxml';
        params = VNSDK.('FirmwareProgrammer+FirmwareUpdater+Params')(firmwareBaudRate, bootloaderBaudRate);
        firmwareUpdater.UpdateFirmware(sensor, vnxml_path, params);

Alternatively, to update using individual VNX files, a ``List`` of :type:`FirmwareProgrammer::FirmwareUpdater::FirmwareFile <VNSDK::FirmwareProgrammer::FirmwareUpdater::FirmwareFile>` objects must be created. This object is a list of VNX firmware files and their associated processor to which to upload the firmware. If multiple VNX files are listed, the firmware will be updated as ordered by this list.

.. tab:: C#

    .. code-block:: C#
    
        List<FirmwareProgrammer.FirmwareUpdater.FirmwareFile> files = new List<FirmwareProgrammer.FirmwareUpdater.FirmwareFile>();
        FirmwareProgrammer.FirmwareUpdater.FirmwareFile navFile = new FirmwareProgrammer.FirmwareUpdater.FirmwareFile(FirmwareProgrammer.FirmwareUpdater.Processor.Nav, navVnxPath);
        files.Add(navFile);
        FirmwareProgrammer.FirmwareUpdater.FirmwareFile gnssFile = new FirmwareProgrammer.FirmwareUpdater.FirmwareFile(FirmwareUpdater.Processor.Gnss, gnssVnxPath);
        files.Add(gnssFile);
        firmwareUpdater.UpdateFirmware(ref sensor, files, fwUpdateParams);

.. tab:: MATLAB

    .. code-block:: matlab

        import System.Collections.Generic.*;
        files = NET.createGeneric('System.Collections.Generic.List', {'VNSDK.FirmwareProgrammer+FirmwareUpdater+FirmwareFile'}, 0);
        navFile = VNSDK.('FirmwareProgrammer+FirmwareUpdater+FirmwareFile')(VNSDK.('FirmwareProgrammer+FirmwareUpdater+Processor').Nav, Nav);
        files.Add(navFile);
        gnssFile = VNSDK.('FirmwareProgrammer+FirmwareUpdater+FirmwareFile')(VNSDK.('FirmwareProgrammer+FirmwareUpdater+Processor').Gnss, Gnss);
        files.Add(gnssFile);
        firmwareUpdater.UpdateFirmware(sensor, files, params);

Command Line 
^^^^^^^^^^^^

The Firmware Update example can also be run as a command-line executable, with the usage defined as:

.. tab:: C#
   
      .. literalinclude:: ../../../cs/examples/FirmwareUpdate/FirmwareUpdate.cs
         :language: c#
         :start-at: usage =
         :end-at: ;
         :dedent: 12

.. tab:: MATLAB

      .. code-block:: matlab

        usage = matlab -batch "[port_name='{port_name};'] [{Processor}='{file_path};'... | vnXml='{file_path}; firmwareBaudRate=<firmware baudrate>; bootloaderBaudRate=<bootloader baudrate>;'] FirmwareUpdate";

For example, the command line can be used as

.. tab:: C#

    .. code-block:: 
    
        >> ./FirmwareUpdate.exe --PortName=COM8 --Nav=./VN310NavFirmware.vnx --Imu=./VN310IMUFirmware.vnx --Gnss=./VN310GnssFirmware.vnx  --firmwareBaudRate=115200 --bootloaderBaudRate=460800

.. tab:: MATLAB

    .. code-block:: matlab

        >> matlab -batch "port_name='COM8'; Nav='./VN310NavFirmware.vnx'; Imu='./VN310IMUFirmware.vnx'; Gnss='./VN310GnssFirmware.vnx'; firmwareBaudRate=115200; bootloaderBaudRate=460800; FirmwareUpdate"

would connect to the sensor using the port COM8 at default 115200 bps, upload the selected NAV firmware file, then the IMU firmware file, then the GNSS firmware file. Each firmware update would occur at the bootloaderBaudRate of 460800 bps.

API
===

The CLI API for the Firmware Programmer plugin is modeled from the C++ API which can be found here:
:ref:`FirmwareProgrammer <plugins_cpp:namespace_VN__FirmwareProgrammer>`
